name: check upstream patches

on: [pull_request]

jobs:
  patch_chk_job:
    runs-on:
      - self-hosted
      - builder
      - Ubuntu
    container: ubuntu:22.04
    name: Patches Check
    steps:
    - name: Get PR info
      id: 'get-pr-info'
      uses: Brymastr/pr-info-action@v1

    - name: Set env var
      run: |
        COMMIT_CNT=$((${{ steps.get-pr-info.outputs.commits }}+1))
        echo "COMMIT_CNT=${COMMIT_CNT}" >> $GITHUB_ENV

    - name: Install deps
      run: |
        apt-get -q=2 update
        apt-get -q=2 install python3 python3-ply python3-git


    - name: Check out repository
      uses: actions/checkout@v2
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: ${{ env.COMMIT_CNT }}

    - name: Set safe.directory
      run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

    - name: Run check scripts
      run: |
        cp -p .github/deps/commits_check.sh ./
        cp -p .github/deps/xmastree.py ./
        cp -p .github/deps/kernel-doc ./
        ./commits_check.sh ${{ steps.get-pr-info.outputs.commits }}
